<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rancho El Arroyo - Diagn√≥stico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }

    .logo {
      max-width: 150px;
    }

    .status-sano {
      color: green;
      font-weight: bold;
    }

    .status-observacion {
      color: orange;
      font-weight: bold;
    }

    .status-enfermo {
      color: red;
      font-weight: bold;
    }

    .spinner {
      display: none;
    }
  </style>
</head>

<body class="container py-4">
  <div class="text-center">
      <img src="logo-rancho.png" class="logo" alt="Logo Rancho El Arroyo" />
    <h1 class="mt-2">Rancho El Arroyo</h1>
    <p class="lead">Sistema de diagn√≥stico de salud bovina</p>
  </div>

  <div id="spinner" class="text-center spinner my-3">
    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>
    <p>Cargando predicciones...</p>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h5>Agregar vaca manualmente</h5>
      <form id="formManual">
        <input class="form-control my-1" name="Animal_ID" placeholder="ID del Animal" required />
        <input class="form-control my-1" name="D√≠a" type="number" placeholder="D√≠a" required />
        <input class="form-control my-1" name="Alimento_Consumido_kg" type="number" step="0.01"
          placeholder="Alimento Consumido (kg)" required />
        <input class="form-control my-1" name="Pasos_por_d√≠a" type="number" placeholder="Pasos por d√≠a" required />
        <input class="form-control my-1" name="Horas_de_Reposo" type="number" step="0.01" placeholder="Horas de Reposo"
          required />
        <input class="form-control my-1" name="Temperatura_Corp_C" type="number" step="0.01"
          placeholder="Temperatura Corporal" required />
        <select class="form-select my-1" name="Nivel_Actividad" required>
          <option value="">Nivel de Actividad</option>
          <option value="Bajo">Bajo</option>
          <option value="Moderado">Moderado</option>
          <option value="Alto">Alto</option>
        </select>
        <button class="btn btn-primary w-100 mt-2">Enviar</button>
      </form>
    </div>
    <div class="col-md-6">
      <h5>Subir CSV</h5>
      <form id="formCSV">
        <input type="file" id="csvInput" class="form-control my-2" accept=".csv" required />
        <button class="btn btn-secondary w-100">Enviar CSV</button>
      </form>
      <button id="btnEjemplo" class="btn btn-outline-success mt-3">üì• Descargar CSV de ejemplo</button>
    </div>
  </div>

  <h5 class="mt-5">üìã Resultados</h5>
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>D√≠a</th>
        <th>Alimento</th>
        <th>Pasos</th>
        <th>Reposo</th>
        <th>Temperatura</th>
        <th>Actividad</th>
        <th>Diagn√≥stico</th>
      </tr>
    </thead>
    <tbody id="tablaResultados"></tbody>
  </table>

  <canvas id="grafica" height="150"></canvas>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-outline-primary" onclick="cambiarPagina(-1)">‚Üê Anterior</button>
    <span id="paginacion" class="fw-bold"></span>
    <button class="btn btn-outline-primary" onclick="cambiarPagina(1)">Siguiente ‚Üí</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const tablaResultados = document.getElementById("tablaResultados");
    const spinner = document.getElementById("spinner");
    const grafica = document.getElementById("grafica").getContext("2d");
    const API_URL = "/api/predict";
    let registros = [], paginaActual = 0, porPagina = 20, grafico;

    function renderTabla() {
      tablaResultados.innerHTML = "";
      const inicio = paginaActual * porPagina;
      const fin = inicio + porPagina;
      const pagina = registros.slice(inicio, fin);
      pagina.forEach(item => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${item.Animal_ID}</td>
          <td>${item.D√≠a}</td>
          <td>${item.Alimento_Consumido_kg}</td>
          <td>${item.Pasos_por_d√≠a}</td>
          <td>${item.Horas_de_Reposo}</td>
          <td>${item.Temperatura_Corp_C}</td>
          <td>${item.Nivel_Actividad}</td>
          <td class="status-${item.prediction.toLowerCase()}">${item.prediction}</td>`;
        tablaResultados.appendChild(fila);
      });
      document.getElementById("paginacion").innerText = `P√°gina ${paginaActual + 1} de ${Math.ceil(registros.length / porPagina)}`;
    }

    function cambiarPagina(delta) {
      const total = Math.ceil(registros.length / porPagina);
      paginaActual = Math.max(0, Math.min(paginaActual + delta, total - 1));
      renderTabla();
    }

    function renderGrafica(data) {
      const conteo = {"Sano": 0, "Observaci√≥n": 0, "Enfermo": 0};
      data.forEach(item => conteo[item.prediction]++);
      if (grafico) grafico.destroy();
      grafico = new Chart(grafica, {
        type: "bar",
        data: {
          labels: ["Sano", "Observaci√≥n", "Enfermo"],
          datasets: [{
            data: [conteo.Sano, conteo["Observaci√≥n"], conteo.Enfermo],
            backgroundColor: ["green", "orange", "red"]
          }]
        }
      });
      if (conteo.Enfermo > 0) alert("‚ö†Ô∏è Se han detectado vacas enfermas.");
    }

    function enviarDatos(valores) {
      spinner.style.display = "block";
      fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({values: valores})
      })
        .then(r => r.json())
        .then(data => {
          registros = data;
          paginaActual = 0;
          renderTabla();
          renderGrafica(data);
        })
        .catch(err => alert("Error al procesar los datos: " + err))
        .finally(() => spinner.style.display = "none");
    }

    document.getElementById("formManual").onsubmit = e => {
      e.preventDefault();
      const form = e.target;
      const vaca = Object.fromEntries(new FormData(form).entries());
      enviarDatos([[vaca.Animal_ID, +vaca.D√≠a, +vaca.Alimento_Consumido_kg, +vaca.Pasos_por_d√≠a, +vaca.Horas_de_Reposo, +vaca.Temperatura_Corp_C, vaca.Nivel_Actividad]]);
    };

    document.getElementById("formCSV").onsubmit = e => {
      e.preventDefault();
      const archivo = document.getElementById("csvInput").files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const vacas = reader.result.split("\n").slice(1).filter(Boolean).map(l => {
          const [id, d, a, p, h, t, n] = l.split(",");
          return [id, +d, +a, +p, +h, +t, n];
        });
        enviarDatos(vacas);
      };
      reader.readAsText(archivo);
    };

    document.getElementById("btnEjemplo").onclick = () => {
      const contenido = "Animal_ID,D√≠a,Alimento_Consumido_kg,Pasos_por_d√≠a,Horas_de_Reposo,Temperatura_Corp_C,Nivel_Actividad\n" +
        "VACA_001,5,20.5,2500,7.5,38.5,Alto\nVACA_002,6,18.3,2200,8.2,39.2,Bajo";
      const blob = new Blob([contenido], {type: "text/csv"});
      const enlace = document.createElement("a");
      enlace.href = URL.createObjectURL(blob);
      enlace.download = "ejemplo.csv";
      enlace.click();
    };

    // Predicci√≥n inicial al cargar
    window.onload = () => {
      enviarDatos([["VACA_001", 5, 20.5, 2500, 7.5, 38.5, "Alto"]]);
    };
  </script>
</body>

</html>
